<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fones de Ouvido Gamer‚ÄØPro ‚Äì √Åudio de Elite</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <style>
        body{background:#1f1f1f;color:#e5e5e5;font-family:'Inter',sans-serif;min-height:100vh;}
        .btn-red{background:#e63946;transform:translateY(0);transition:transform .2s,box-shadow .3s;box-shadow:0 4px 15px rgba(230,57,70,.4);}
        .btn-red:hover{background:#b91c1c;transform:translateY(-2px);box-shadow:0 6px 20px rgba(230,57,70,.6);}
        .section-title{position:relative;display:inline-block;margin-bottom:1.5rem;text-shadow:0 2px 4px rgba(0,0,0,.5);}
        .section-title::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:50%;height:3px;background:#e63946;}
        .carousel-img{transition:transform .3s,box-shadow .3s;}
        .carousel-img:hover{transform:scale(1.05);box-shadow:0 8px 20px rgba(230,57,70,.3);}
        .comment-card{display:flex;align-items:flex-start;transition:transform .2s,box-shadow .3s;background:#2a2a2a;padding:1.5rem;border-radius:8px;margin-bottom:1rem;}
        .comment-card:hover{transform:translateY(-4px);box-shadow:0 6px 15px rgba(230,57,70,.3);}
        .comment-avatar{width:48px;height:48px;border-radius:50%;margin-right:1rem;object-fit:cover;border:2px solid #e63946;}
        .comment-content{flex:1;}
        .comment-date{font-size:.875rem;color:#6b7280;}
        section,header,footer{position:relative;z-index:1;}
        section::before,header::before,footer::before,
        section::after,header::after,footer::after{content:'';position:absolute;left:0;right:0;height:20px;z-index:-1;}
        header::before{top:-20px;background:linear-gradient(to bottom,transparent,#1f1f1f);}
        header::after{bottom:-20px;background:linear-gradient(to bottom,#1f1f1f,#2a2a2a);}
        section:nth-of-type(1)::before{top:-20px;background:linear-gradient(to bottom,#2a2a2a,#1f1f1f);}
        section::after{bottom:-20px;background:linear-gradient(to bottom,#1f1f1f,#2a2a2a);}
        section:nth-of-type(2)::before,section:nth-of-type(3)::before{top:-20px;background:linear-gradient(to bottom,#2a2a2a,#1f1f1f);}
        section:nth-of-type(2)::after,section:nth-of-type(3)::after{bottom:-20px;background:linear-gradient(to bottom,#1f1f1f,#2a2a2a);}
        footer::before{top:-20px;background:linear-gradient(to bottom,#2a2a2a,#1f1f1f);}
        input,textarea{transition:box-shadow .3s,border-color .3s;}
        input:focus,textarea:focus{box-shadow:0 0 10px rgba(230,57,70,.4);border-color:#e63946;}
        .carousel-container{position:relative;width:100%;max-width:600px;margin:0 auto;overflow:hidden;border-radius:8px;}
        .carousel{display:flex;width:100%;transition:transform .5s ease-in-out;}
        .carousel-item{flex:0 0 100%;width:100%;}
        .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#e5e5e5;padding:.5rem 1rem;border:none;cursor:pointer;font-size:1.5rem;transition:background .3s;z-index:10;}
        .carousel-btn:hover{background:rgba(230,57,70,.7);}
        .prev-btn{left:10px}.next-btn{right:10px}
        .carousel-dots{position:absolute;bottom:15px;left:50%;transform:translateX(-50%);display:flex;gap:8px;}
        .carousel-dot{width:12px;height:12px;background:#2a2a2a;border-radius:50%;cursor:pointer;transition:background .3s;}
        .carousel-dot.active{background:#e63946;}
        #commentsList{display:flex;flex-direction:column;gap:1rem;}
        @media(min-width:768px){
            #commentsList{flex-direction:row;flex-wrap:wrap;justify-content:space-between;}
            .comment-card{flex:0 0 calc(50% - .5rem);}
        }
    </style>
    <link rel="icon" href="TEC.png" type="image/x-icon">
    <script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');fbq('init','3039782552846318');fbq('track','PageView');</script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=3039782552846318&ev=PageView&noscript=1"/></noscript>
</head>
<body class="font-sans">
<header class="text-white py-6" style="background-color:#1f1f1f;">
    <div class="container mx-auto text-center">
        <h1 class="text-4xl md:text-5xl font-bold">Fone de Ouvido Gamer‚ÄØPro</h1>
        <p class="mt-3 text-lg md:text-xl text-gray-400">Entre no campo de batalha com √°udio de elite e conquiste a vit√≥ria que voc√™ merece.</p>
    </div>
</header>

<section class="py-16" style="background-color:#1f1f1f;">
<div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row items-center">
        <div class="md:w-1/2">
            <div class="carousel-container" role="region" aria-label="Carrossel de imagens do produto">
                <div class="carousel" id="carousel">
                    <div class="carousel-item"><img src="fone-venda.webp" alt="Imagem 1" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+1'"></div>
                    <div class="carousel-item"><img src="fone-venda-2.webp" alt="Imagem 2" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+2'"></div>
                    <div class="carousel-item"><img src="fone-venda-3.webp" alt="Imagem 3" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+3'"></div>
                    <div class="carousel-item"><img src="fone-venda-4.webp" alt="Imagem 4" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+4'"></div>
                    <div class="carousel-item"><img src="fone-venda-5.webp" alt="Imagem 5" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+5'"></div>
                    <div class="carousel-item"><img src="fone-venda-6.webp" alt="Imagem 6" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+6'"></div>
                    <div class="carousel-item"><img src="fone-venda-7.webp" alt="Imagem 7" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+7'"></div>
                    <div class="carousel-item"><img src="fone-venda-8.webp" alt="Imagem 8" class="carousel-img rounded-lg shadow-lg w-full" onerror="this.src='https://via.placeholder.com/600x400?text=Imagem+8'"></div>
                </div>
                <button class="carousel-btn prev-btn" aria-label="Imagem anterior">‚ùÆ</button>
                <button class="carousel-btn next-btn" aria-label="Pr√≥xima imagem">‚ùØ</button>
                <div class="carousel-dots" id="carousel-dots" role="tablist"></div>
            </div>
        </div>
        <div class="md:w-1/2 md:pl-8 mt-8 md:mt-0">
            <h2 class="text-3xl md:text-4xl font-bold text-white section-title">Imagine a cena decisiva‚Ä¶</h2>
            <p class="mt-4 text-gray-400">
                A tela treme com uma explos√£o, voc√™ ouve passos furtivos pelo flanco direito e, num instante, reage antes que o inimigo
                sabe de onde veio o ataque. Essa vantagem nasce aqui ‚Äì nos detalhes de engenharia do <strong>Gamer‚ÄØPro</strong>.
            </p>
            <h3 class="mt-6 text-2xl font-bold text-white">Por que eleva seu jogo:</h3>
            <ul class="mt-4 space-y-4 text-gray-300">
                <li><span class="font-bold text-red-500">üéß Som Surround 7.1:</span> Camadas sonoras realistas para identificar posi√ß√µes, dist√¢ncias e movimentos com precis√£o cir√∫rgica.</li>
                <li><span class="font-bold text-red-500">üîá Tripla barreira de ru√≠do + microfone PRO:</span> DSP inteligente, c√°psulas PET focadas em voz e haste met√°lica destac√°vel para comunica√ß√£o cristalina.</li>
                <li><span class="font-bold text-red-500">üïπÔ∏è Conector em ‚ÄúL‚Äù:</span> plugue a 90¬∞ que n√£o atrapalha a pegada no controle ou celular.</li>
                <li><span class="font-bold text-red-500">üëÇ Conforto que n√£o cede:</span> almofadas de silicone que n√£o escorregam, ideais para maratonas de jogo.</li>
            </ul>
            <p class="mt-6 text-gray-400">
                <strong>N√£o jogue mais no escuro sonoro.</strong> Clique em ‚ÄúComprar agora‚Äù e transforme cada partida em um espet√°culo de imers√£o, precis√£o e conforto.
            </p>
        </div>
    </div>
    <div class="mt-12 p-8 rounded-lg" style="background-color:#2a2a2a;">
        <h3 class="text-2xl md:text-3xl font-bold text-white section-title">Especifica√ß√µes que fazem a diferen√ßa</h3>
        <ul class="mt-6 text-gray-400 grid grid-cols-1 md:grid-cols-2 gap-4">
            <li><strong>Frequ√™ncia:</strong> 20 Hz ‚Äì 20 kHz</li>
            <li><strong>Imped√¢ncia:</strong> 16 Œ©</li>
            <li><strong>Sensibilidade:</strong> 109 dB</li>
            <li><strong>Distor√ß√£o Harm√¥nica:</strong> ‚â§ 1 %</li>
            <li><strong>Driver:</strong> 10 mm ‚Äì diafragma de alta precis√£o</li>
            <li><strong>Cabo:</strong> 1,2 m em TPE flex√≠vel e resistente</li>
            <li><strong>Plugue:</strong> P3 3,5 mm ‚ÄúL-bend‚Äù</li>
            <li><strong>Tipo:</strong> In-ear com fio</li>
            <li><strong>Microfones:</strong> Integrado + haste remov√≠vel com cancelamento</li>
        </ul>
    </div>
    <p class="mt-6 text-lg text-red-600 font-bold text-center">Por apenas <span class="text-2xl">R$ 59,99</span> transforme sua experi√™ncia de jogo HOJE!</p>
    <div class="mt-8 text-center">
        <a href="https://wa.me/5584991562754?text=ol%C3%A1,%20estou%20interessado%20pelo%20fone%20e%20gostaria%20de%20comprar%20!%F0%9F%98%83%F0%9F%98%83"
           class="btn-red text-white px-8 py-4 rounded-lg text-lg font-semibold shadow-lg inline-block"
           aria-label="Comprar pelo WhatsApp" target="_blank">Comprar pelo WhatsApp</a>
    </div>
</div>
</section>

<section class="py-8" style="background-color:#1f1f1f;">
    <div class="container mx-auto text-center">
        <blockquote class="text-gray-200 italic text-lg max-w-2xl mx-auto">
            ‚ÄúOuvi o passo do advers√°rio antes dele virar a esquina. Essa fra√ß√£o de segundo valeu a vit√≥ria do time.‚Äù<br>
            <span class="font-bold text-white">‚Äì Thiago M., jogador competitivo</span>
        </blockquote>
    </div>
</section>

<section class="py-16" style="background-color:#1f1f1f;">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center text-white section-title">O que os Gamers Est√£o Dizendo</h2>
        <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="comment-card p-6 rounded-lg shadow-lg"><p class="text-gray-400">"O som √© t√£o claro que ouvi o inimigo antes de v√™-lo! Esses fones mudaram meu jogo."</p><p class="mt-4 font-bold text-white">- Jo√£o Silva</p></div>
            <div class="comment-card p-6 rounded-lg shadow-lg"><p class="text-gray-400">"Confort√°veis por horas e o microfone √© perfeito para estrat√©gias em equipe."</p><p class="mt-4 font-bold text-white">- Maria Oliveira</p></div>
            <div class="comment-card p-6 rounded-lg shadow-lg"><p class="text-gray-400">"Melhor custo-benef√≠cio que j√° vi. N√£o jogo mais sem eles!"</p><p class="mt-4 font-bold text-white">- Pedro Santos</p></div>
        </div>
    </div>
</section>

<section class="py-16" style="background-color:#1f1f1f;">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center text-white section-title">Deixe Seu Coment√°rio</h2>
        <p class="mt-3 text-center text-gray-400">Compartilhe sua experi√™ncia com os Fones de Ouvido Gamer Pro!</p>
        <div class="mt-10 max-w-md mx-auto">
            <div id="registerFormContainer" class="space-y-4">
                <input type="text" id="registerUsername" placeholder="Seu Usu√°rio (3-20 caracteres)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600 text-white" required>
                <input type="email" id="registerEmail" placeholder="Seu Email" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600 text-white" required>
                <button id="submitRegister" class="w-full btn-red text-white px-6 py-3 rounded-lg text-lg font-semibold" aria-label="Registrar Usu√°rio">Registrar</button>
                <p class="text-center text-gray-400">J√° tem um usu√°rio? <a href="#" id="showCommentForm" class="text-red-500 hover:underline">Comentar diretamente</a></p>
            </div>
            <form id="commentForm" class="space-y-4 hidden">
                <p class="text-gray-400">Comentando como: <span id="currentUsername" class="font-bold"></span> (<a href="#" id="logout" class="text-red-500 hover:underline">Sair</a>)</p>
                <input type="email" id="commentEmail" placeholder="Seu Email" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600 text-white" required>
                <textarea id="commentMessage" placeholder="Seu Coment√°rio" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600 text-white" rows="4" required></textarea>
                <button type="submit" id="submitComment" class="w-full btn-red text-white px-6 py-3 rounded-lg text-lg font-semibold" aria-label="Enviar Coment√°rio">Enviar Coment√°rio</button>
                <p class="text-center text-gray-400">N√£o tem um usu√°rio? <a href="#" id="showRegisterForm" class="text-red-500 hover:underline">Registrar</a></p>
            </form>
        </div>
        <h3 class="mt-16 text-2xl font-bold text-center text-white">Coment√°rios dos Usu√°rios</h3>
        <div id="connectionStatus" class="text-center text-gray-400" role="status"></div>
        <div id="commentsList" class="mt-8" role="list"></div>
    </div>
</section>

<footer class="text-white py-6" style="background-color:#1f1f1f;">
    <div class="container mx-auto text-center">
        <p>¬© 2025 Fones de Ouvido Gamer Pro. Todos os direitos reservados.</p>
        <p class="mt-2 text-sm text-gray-400">Envio em at√© 24 h em dias √∫teis | Suporte dedicado</p>
    </div>
</footer>

<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<script>
const API_BASE_URL = 'https://backend-fone.onrender.com';
let socket = null;

function updateConnectionStatus(status, msg) {
    const el = document.getElementById('connectionStatus');
    if (!el) {
        console.warn('connectionStatus element not found');
        return;
    }
    if (status === 'connected') {
        el.textContent = '';
        el.className = 'text-center text-gray-400';
        return;
    }
    el.textContent = msg;
    el.className = `text-center ${status === 'disconnected' ? 'text-red-600' : 'text-yellow-600'}`;
    console.log(`Connection status: ${status} - ${msg}`);
}

function initializeSocket() {
    try {
        socket = io(API_BASE_URL, {
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            randomizationFactor: 0.5
        });
        socket.on('connect', () => {
            console.log('Socket connected');
            updateConnectionStatus('connected');
            loadComments();
        });
        socket.on('disconnect', () => {
            console.warn('Socket disconnected');
            updateConnectionStatus('disconnected', 'Conex√£o perdida. Tentando reconectar...');
        });
        socket.on('reconnect', () => {
            console.log('Socket reconnected');
            loadComments();
        });
        socket.on('reconnect_attempt', () => {
            console.log('Socket reconnect attempt');
            updateConnectionStatus('reconnecting', 'Tentando reconectar...');
        });
        socket.on('reconnect_failed', () => {
            console.error('Socket reconnect failed');
            updateConnectionStatus('disconnected', 'N√£o foi poss√≠vel reconectar. Recarregue a p√°gina.');
        });
        socket.on('newComment', (comment) => {
            if (comment && comment.message && comment.createdAt) {
                console.log('New comment received:', comment);
                addCommentToDOM(comment);
            } else {
                console.warn('Invalid comment received:', comment);
            }
        });
        socket.on('connect_error', (err) => {
            console.error('Socket connection error:', err.message);
            updateConnectionStatus('disconnected', 'Erro na conex√£o com o servidor.');
        });
    } catch (e) {
        console.error('Socket initialization failed:', e);
        updateConnectionStatus('disconnected', 'Erro na inicializa√ß√£o da conex√£o.');
    }
}

const carousel = document.getElementById('carousel');
const items = document.querySelectorAll('.carousel-item');
const prevBtn = document.querySelector('.prev-btn');
const nextBtn = document.querySelector('.next-btn');
const dotsContainer = document.getElementById('carousel-dots');
let currentIndex = 0;

function createDots() {
    if (!dotsContainer) {
        console.warn('carousel-dots element not found');
        return;
    }
    dotsContainer.innerHTML = '';
    items.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.classList.add('carousel-dot');
        dot.setAttribute('role', 'tab');
        dot.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(i));
        dotsContainer.appendChild(dot);
    });
}

function updateCarousel() {
    if (!carousel) {
        console.warn('carousel element not found');
        return;
    }
    carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
    const dots = document.querySelectorAll('.carousel-dot');
    dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
        dot.setAttribute('aria-selected', i === currentIndex ? 'true' : 'false');
    });
}

function goToSlide(index) {
    currentIndex = (index + items.length) % items.length;
    updateCarousel();
}

function initializeCarousel() {
    if (!carousel || !items.length || !prevBtn || !nextBtn || !dotsContainer) {
        console.warn('Carousel elements missing');
        return;
    }
    createDots();
    updateCarousel();
    prevBtn.addEventListener('click', () => goToSlide(currentIndex - 1));
    nextBtn.addEventListener('click', () => goToSlide(currentIndex + 1));
    let autoSlide = setInterval(() => goToSlide(currentIndex + 1), 5000);
    carousel.addEventListener('mouseenter', () => clearInterval(autoSlide));
    carousel.addEventListener('mouseleave', () => {
        autoSlide = setInterval(() => goToSlide(currentIndex + 1), 5000);
    });
}

function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"'\/]/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
        '/': '&#x2F;'
    }[char]));
}

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash &= hash;
    }
    return Math.abs(hash);
}

const avatarColors = [
    'E63946', '457B9D', '2A9D8F', 'F4A261', '9B59B6', 'E76F51',
    '2196F3', '4CAF50', 'FF9800', '6D4C41', '00BCD4', 'F06292'
];

function getAvatarUrl(username, email) {
    const seed = encodeURIComponent(username || 'unknown');
    const hashInput = (username || '') + (email || '');
    const colorIndex = hashInput ? simpleHash(hashInput) % avatarColors.length : 0;
    const color = avatarColors[colorIndex];
    return `https://api.dicebear.com/9.x/initials/svg?seed=${seed}&backgroundColor=${color}&fontSize=40`;
}

function showRegisterForm() {
    const registerForm = document.getElementById('registerFormContainer');
    const commentForm = document.getElementById('commentForm');
    if (registerForm) registerForm.classList.remove('hidden');
    if (commentForm) commentForm.classList.add('hidden');
}

function showCommentForm() {
    let user = null;
    try {
        const userData = localStorage.getItem('user');
        if (userData) user = JSON.parse(userData);
    } catch (e) {
        console.error('Failed to parse user from localStorage:', e);
    }
    const currentUsername = document.getElementById('currentUsername');
    const registerForm = document.getElementById('registerFormContainer');
    const commentForm = document.getElementById('commentForm');
    if (user && user.id && user.username && currentUsername && registerForm && commentForm) {
        currentUsername.textContent = user.username;
        registerForm.classList.add('hidden');
        commentForm.classList.remove('hidden');
    } else {
        showRegisterForm();
    }
}

function logout() {
    try {
        localStorage.removeItem('user');
        showRegisterForm();
    } catch (e) {
        console.error('Logout failed:', e);
        alert('Erro ao fazer logout. Tente novamente.');
    }
}

function addCommentToDOM(comment) {
    const list = document.getElementById('commentsList');
    if (!list) {
        console.warn('commentsList element not found');
        return;
    }
    const empty = list.querySelector('p.text-gray-400.text-center');
    if (empty) list.innerHTML = '';
    if (!comment || !comment.message || !comment.createdAt) {
        console.warn('Invalid comment data:', comment);
        return;
    }
    const card = document.createElement('div');
    card.className = 'comment-card';
    card.setAttribute('role', 'listitem');
    const username = comment.userId?.username || comment.name || 'An√¥nimo';
    const email = comment.userId?.email || comment.email || '';
    const createdAt = comment.createdAt ? new Date(comment.createdAt).toLocaleDateString('pt-BR') : 'Data desconhecida';
    card.innerHTML = `
        <img src="${getAvatarUrl(username, email)}" alt="Avatar de ${escapeHTML(username)}" class="comment-avatar">
        <div class="comment-content">
            <p class="text-gray-400">${escapeHTML(comment.message)}</p>
            <p class="mt-2 font-bold text-white">- ${escapeHTML(username)}</p>
            <p class="comment-date">${createdAt}</p>
        </div>`;
    list.prepend(card);
}

async function loadComments(attempt = 1) {
    const list = document.getElementById('commentsList');
    if (!list) {
        console.warn('commentsList element not found');
        return;
    }
    list.innerHTML = '<p class="text-gray-400 text-center">Carregando coment√°rios...</p>';
    try {
        const response = await fetch(`${API_BASE_URL}/api/comments`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || errorData.details || `Erro HTTP: ${response.status}`);
        }
        const comments = await response.json();
        list.innerHTML = '';
        if (!comments || !Array.isArray(comments) || comments.length === 0) {
            list.innerHTML = '<p class="text-gray-400 text-center">Nenhum coment√°rio ainda. Seja o primeiro!</p>';
            return;
        }
        comments.reverse().forEach(comment => {
            if (comment && comment.message) addCommentToDOM(comment);
        });
    } catch (err) {
        console.error(`Attempt ${attempt} failed to load comments:`, err);
        if (attempt < 3) {
            setTimeout(() => loadComments(attempt + 1), attempt * 2000);
        } else {
            list.innerHTML = `<p class="text-red-600 text-center">Erro ao carregar coment√°rios: ${err.message}. Tente recarregar a p√°gina.</p>`;
        }
    }
}

function initializeEventListeners() {
    const showRegisterLink = document.getElementById('showRegisterForm');
    const showCommentLink = document.getElementById('showCommentForm');
    const logoutLink = document.getElementById('logout');
    const submitRegisterBtn = document.getElementById('submitRegister');
    const commentForm = document.getElementById('commentForm');

    if (showRegisterLink) {
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });
    }

    if (showCommentLink) {
        showCommentLink.addEventListener('click', (e) => {
            e.preventDefault();
            showCommentForm();
        });
    }

    if (logoutLink) {
        logoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    if (submitRegisterBtn) {
        submitRegisterBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('registerUsername');
            const emailInput = document.getElementById('registerEmail');
            if (!usernameInput || !emailInput) {
                console.warn('Register form inputs missing');
                alert('Formul√°rio incompleto.');
                return;
            }
            const username = usernameInput.value.trim();
            const email = emailInput.value.trim();
            if (!username || !email) {
                alert('Preencha usu√°rio e email.');
                return;
            }
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
                alert('Usu√°rio deve ter 3-20 caracteres e conter apenas letras, n√∫meros ou sublinhados.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Email inv√°lido.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao registrar');
                }
                localStorage.setItem('user', JSON.stringify({ id: data.user.id, username: data.user.username }));
                alert('Usu√°rio registrado com sucesso!');
                showCommentForm();
            } catch (err) {
                console.error('Register failed:', err);
                alert(`Erro: ${err.message}`);
            }
        });
    }

    if (commentForm) {
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let user = null;
            try {
                const userData = localStorage.getItem('user');
                if (userData) user = JSON.parse(userData);
            } catch (err) {
                console.error('Failed to parse user from localStorage:', err);
            }
            if (!user || !user.id) {
                showRegisterForm();
                alert('Por favor, registre um usu√°rio primeiro.');
                return;
            }
            const emailInput = document.getElementById('commentEmail');
            const messageInput = document.getElementById('commentMessage');
            if (!emailInput || !messageInput) {
                console.warn('Comment form inputs missing');
                alert('Formul√°rio incompleto.');
                return;
            }
            const email = emailInput.value.trim();
            const message = messageInput.value.trim();
            if (!email || !message) {
                alert('Preencha email e mensagem.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Email inv√°lido.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, message })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao enviar coment√°rio');
                }
                alert('Coment√°rio enviado!');
                commentForm.reset();
            } catch (err) {
                console.error('Comment submission failed:', err);
                alert(`Erro: ${err.message}`);
            }
        });
    }
}

function initializePing() {
    setInterval(async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/ping`);
            if (!response.ok) {
                console.warn('Ping failed:', response.status);
            }
        } catch (e) {
            console.error('Ping error:', e);
        }
    }, 300000);
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing components');
    initializeSocket();
    initializeCarousel();
    initializeEventListeners();
    initializePing();
    showCommentForm();
    loadComments();
});
</script>
</body>
</html>