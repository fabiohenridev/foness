<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>visitas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <style>
*{
    color: rgb(47, 255, 0);
    background: rgb(38, 37, 37);
    font-size: 30px;
}
.mt-4{
    display: flex;
    align-items: center;
    height: 100vh;
    width: 100vw;
    justify-content: center;
}
    </style>
</head>
<body>
    <div class="mt-4">
        <span style="color: rgb(0, 0, 0); background-color: aliceblue; padding: 10px; font-family: sans-serif; border-radius: 10px;" id="visitCount" class="text-gray-400 ml-2">Total de visitas: 0</span>
        <button id="deleteVisitsBtn" style="color: rgb(255, 0, 0); background-color: aliceblue; padding: 10px; margin-left: 10px; font-family: sans-serif; border-radius: 10px;" aria-label="Excluir total de visitas">
            <i class="fas fa-trash"></i> Excluir Visitas
        </button>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
const API_BASE_URL = 'https://backend-fone.onrender.com';
let socket = null;

function updateConnectionStatus(status, msg) {
    const el = document.getElementById('connectionStatus');
    if (!el) {
        console.warn('connectionStatus element not found');
        return;
    }
    if (status === 'connected') {
        el.textContent = '';
        el.className = 'text-center text-gray-400';
    } else {
        el.textContent = msg;
        el.className = `text-center ${status === 'disconnected' ? 'text-red-600' : 'text-yellow-600'}`;
    }
    console.log(`Connection status: ${status} - ${msg}`);
}

function initializeSocket() {
    try {
        socket = io(API_BASE_URL, {
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            randomizationFactor: 0.5,
            timeout: 10000
        });
        socket.on('connect', () => {
            console.log('Socket connected');
            updateConnectionStatus('connected', '');
        });
        socket.on('disconnect', () => {
            console.warn('Socket disconnected');
            updateConnectionStatus('disconnected', 'Conexão perdida. Tentando reconectar...');
        });
        socket.on('reconnect', () => {
            console.log('Socket reconnected');
            updateConnectionStatus('connected', '');
        });
        socket.on('reconnect_attempt', () => {
            console.log('Socket reconnect attempt');
            updateConnectionStatus('reconnecting', 'Tentando reconectar...');
        });
        socket.on('reconnect_failed', () => {
            console.error('Socket reconnect failed');
            updateConnectionStatus('disconnected', 'Não foi possível reconectar. Recarregue a página.');
        });
        socket.on('connect_error', (err) => {
            console.error('Socket connection error:', err.message);
            updateConnectionStatus('disconnected', `Erro na conexão com o servidor: ${err.message}`);
        });
    } catch (e) {
        console.error('Socket initialization failed:', e);
        updateConnectionStatus('disconnected', 'Erro na inicialização da conexão.');
    }
}

async function fetchVisitCount() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/visits/count`);
        if (!response.ok) {
            throw new Error('Erro ao buscar total de visitas');
        }
        const data = await response.json();
        return data.totalVisits;
    } catch (error) {
        console.error('Erro ao buscar total de visitas:', error);
        return 0;
    }
}

async function deleteVisits() {
    if (!confirm('Tem certeza que deseja excluir todas as visitas? Esta ação não pode ser desfeita.')) {
        console.log('Exclusão de visitas cancelada pelo usuário');
        return;
    }
    try {
        const response = await fetch(`${API_BASE_URL}/api/visits`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer minha-chave-secreta' // Substitua por uma chave segura
            }
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Erro ao excluir visitas');
        }
        const visitCountElement = document.getElementById('visitCount');
        visitCountElement.textContent = 'Total de visitas: 0';
        console.log('Visitas excluídas com sucesso');
        alert('Visitas excluídas com sucesso!');
    } catch (error) {
        console.error('Erro ao excluir visitas:', error);
        alert(`Erro: ${error.message}`);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing components');
    try {
        initializeSocket();
        fetchVisitCount().then(count => {
            const visitCountElement = document.getElementById('visitCount');
            visitCountElement.textContent = `Total de visitas: ${count}`;
        });
        const deleteVisitsBtn = document.getElementById('deleteVisitsBtn');
        if (deleteVisitsBtn) {
            deleteVisitsBtn.addEventListener('click', deleteVisits);
        }
    } catch (e) {
        console.error('Initialization failed:', e);
        alert('Erro ao inicializar a página. Recarregue e tente novamente.');
    }
});
    </script>
</body>
</html>